<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chụp Ảnh và Lưu Dữ Liệu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <style>
        #video { display: none; }
        #canvas { display: none; }
        button { margin: 10px; }
    </style>
</head>
<body>
    <h1>Chọn File Excel và Chụp Ảnh</h1>

    <!-- Input chọn file Excel -->
    <input type="file" id="file-input" accept=".xlsx, .xls" />

    <!-- Bảng để hiển thị dữ liệu Excel -->
    <table id="data-table" border="1">
        <thead>
            <tr>
                <th>Col 1</th>
                <th>Col 2</th>
                <th>Col 3</th>
                <th>Col 4</th>
                <th>Col 5</th>
                <th>Col 6 (Camera)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Nút mở camera -->
    <button id="start-camera" style="display: none;">Chụp Ảnh</button>

    <!-- Phần hiển thị camera -->
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        let fileInput = document.getElementById('file-input');
        let dataTable = document.getElementById('data-table').getElementsByTagName('tbody')[0];
        let startCameraButton = document.getElementById('start-camera');
        let videoElement = document.getElementById('video');
        let canvasElement = document.getElementById('canvas');
        let context = canvasElement.getContext('2d');
        let currentFileName = '';

        // Đọc và hiển thị dữ liệu từ Excel
        fileInput.addEventListener('change', function(event) {
            let file = event.target.files[0];
            let reader = new FileReader();
            
            reader.onload = function(e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, { type: 'array' });
                let sheet = workbook.Sheets[workbook.SheetNames[0]];
                let jsonData = XLSX.utils.sheet_to_json(sheet);
                
                // Hiển thị dữ liệu vào bảng
                jsonData.forEach((row, index) => {
                    let newRow = dataTable.insertRow();
                    Object.keys(row).slice(0, 5).forEach(key => {
                        let cell = newRow.insertCell();
                        cell.textContent = row[key];
                    });

                    let cameraCell = newRow.insertCell();
                    let button = document.createElement('button');
                    button.textContent = 'Chụp Ảnh';
                    button.onclick = function() {
                        currentFileName = row['mã kks thiết bị']; // Giả sử cột "mã kks thiết bị" có tên là như vậy
                        startCameraButton.style.display = 'inline-block'; // Hiện nút mở camera
                    };
                    cameraCell.appendChild(button);
                });
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Bắt đầu mở camera
        startCameraButton.addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    startCameraButton.style.display = 'none';
                    
                    // Sau khi mở camera, chụp ảnh
                    setTimeout(() => captureImage(), 2000);
                })
                .catch(function(error) {
                    console.log("Lỗi khi mở camera: ", error);
                });
        });

        // Chụp ảnh từ video và lưu lại
        function captureImage() {
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            let imageData = canvasElement.toDataURL('image/jpeg');

            // Đổi tên file và tải về
            let link = document.createElement('a');
            link.href = imageData;
            link.download = currentFileName + '.jpg'; // Đổi tên file ảnh
            link.click();

            // Dừng camera
            let stream = videoElement.srcObject;
            let tracks = stream.getTracks();
            tracks.forEach(track => track.stop());

            videoElement.style.display = 'none';
            canvasElement.style.display = 'none';
        }
    </script>
</body>
</html>
